from flask import Flask, render_template, flash, url_for, request, redirect, jsonify
from flask_mail import Mail,Message
from db import connection
#flask mail config file
from config_mail import username,pw

app = Flask(__name__)


app.secret_key = 'A0Zr98j/3yX R~XHH!jmN]LWX/,?RT'

app.config.update(
  MAIL_SERVER='smtp.office365.com',
  MAIL_PORT = 587,
  MAIL_USERNAME = username,
  MAIL_PASSWORD = pw,
  MAIL_USE_TLS = True,
  MAIL_USE_SSL = False
)

mail = Mail(app)

@app.route('/',methods=['GET','POST'])
def main():

  if request.method == 'POST':
    name = request.form['username']
    email = request.form['email']
    message = request.form['text-content']
    if name and email:

      msg = Message(subject='New Enquiry from first page',sender='enquiries@russellhewes.co.uk', recipients = ['enquiries@russellhewes.co.uk','chanelle@russellhewes.co.uk'])
      msg.body = 'Hello Russell you cunt!\n\nSomeone has sent you an enquiry probably best to mail them back.\n\nTheir name is;\n\n' + name.title() + '\n\nTheir email is;\n\n' + email + '\n\nTheir message said this;\n\n' + message
      mail.send(msg)

      msg = Message(subject='Russell Hewes - Enquiry',sender='enquiries@russellhewes.co.uk', recipients = [email])
      msg.body = 'Dear ' + name.title() + ',\n\nThank you for your enquiry.\n\nOne of our members of staff will be in touch shortly.\n\nKind Regards,\n\nRussell Hewes'
      mail.send(msg)
      flash('Thank you for your enquiry, someone from our team will be in contact with you very shortly','success')
      return redirect(url_for('main'))
    else:
      flash('You have not filled in all mandatory fields, please try again','danger')
      return redirect(url_for('main',_anchor='contact'))
  else:
    #use pymysql cursor
    with connection.cursor() as cursor:
      text_content_query = "SELECT * FROM `home_page`"
      cursor.execute(text_content_query,(),)
      result = cursor.fetchall()


    return render_template('index.html',data=result)


@app.route('/<type>',methods=['GET','POST'])
def job(type):

  if request.method == 'POST':
    email = request.form['email']
    name = request.form['username']
    message = request.form['text-content']
    subject_type = request.form['email-type']
    if name and email:
      subject = 'New enqiury about ' + subject_type
      msg = Message(subject=subject,sender='enquiries@russellhewes.co.uk', recipients = ['enquiries@russellhewes.co.uk','chanelle@russellhewes.co.uk'])
      msg.body = 'Hello Russell you cunt!\n\nSomeone has sent you an enquiry about ' + subject_type + ' probably best to mail them back.\n\nTheir name is;\n\n' + name.title() + '\n\nTheir email is;\n\n' + email + '\n\nTheir message said this;\n\n' + message
      mail.send(msg)
      subject = 'Russell Hewes - ' + subject_type.title()
      msg = Message(subject=subject,sender='enquiries@russellhewes.co.uk', recipients = [email])
      msg.body = 'Dear ' + name.title() + ',\n\nThank you for your enquiry regarding our ' + subject_type + ' team.\n\nOne of our members of staff will be in touch shortly.\n\nKind Regards,\n\nRussell Hewes'
      mail.send(msg)
      flash('Thank you for your enquiry, someone from our ' + subject_type + ' team will be in contact with you very shortly','success')

    else:
      flash('You have not filled in all mandatory fields, please try again','danger')

    return redirect(url_for('job',type=subject_type))
  else:
    #use pymysql cursor
    with connection.cursor() as cursor:
      cursor.execute("SELECT * FROM {0}".format(type))
      result = cursor.fetchall()
      print(result)

      cursor.execute("SELECT brief FROM {0}_info INNER JOIN {1} ON {2}.id = {3}_info.ref_id".format(type,type,type,type))
      rows = cursor.fetchall()

      cursor.execute("SELECT img_name FROM {0}_back".format(type))
      title_img = cursor.fetchall()
      title = None
      for x in title_img:
        title = x['img_name']

  return render_template('content.html',data=result,brief=rows,type=type,title=title)

@app.route('/home-images')
def home_images():
    with connection.cursor() as cursor:

      img_name_query = "SELECT * FROM `home_page_img`"
      cursor.execute(img_name_query,(),)
      picture_rows = cursor.fetchall()

    return jsonify(picture_rows)


if __name__ == "__main__":
    app.run(debug=True)
